#define VK_USE_PLATFORM_XLIB_KHR
#include<SDL2/SDL.h>
#include<SDL2/SDL_vulkan.h>
#include<vulkan/vulkan.h>
#include<stdio.h>
#include<stdlib.h>
#include<string.h>
#include<math.h>
#include<stdint.h>
#include<assert.h>
typedef uint8_t u8;typedef uint16_t u16;typedef uint32_t u32;typedef int32_t i32;typedef float f32;
typedef struct{f32 x,y,z;}V3;typedef struct{f32 x,y,z,w;}V4;typedef struct{f32 m[16];}M4;typedef struct{i32 x,y,z;}I3;
#define R return
#define L(n,c) for(i32 _i=0;_i<(n);_i++){c}
#define S sizeof
#define M malloc
#define F free
typedef struct{i32 o,n;}BL;typedef struct{char n[64];i32 f,c;}BD;typedef struct{V3 mn,mx;}BB;typedef struct{i32 p,cl[2],mn[3],mx[3];}BN;typedef struct{i32 t,e,f,v,nv,m,ne;}BF;typedef struct{V3 p,n;f32 u[2],lu[2];u8 c[4];}BV;typedef struct{char n[64];i32 f,c;}BT;
typedef struct{i32 mg;BL e[17];}BH;typedef struct{u8*d;BH h;i32 sz;}BP;typedef struct{VkImage i;VkDeviceMemory m;VkImageView v;u32 w,h;}TX;typedef struct{VkBuffer b;VkDeviceMemory m;u32 sz;}BU;typedef struct{BV*v;u32*ix;u32 nv,ni;TX*tx;i32 nt;}MG;
V3 v3(f32 x,f32 y,f32 z){R(V3){x,y,z};}V3 v3a(V3 a,V3 b){R v3(a.x+b.x,a.y+b.y,a.z+b.z);}V3 v3s(V3 a,V3 b){R v3(a.x-b.x,a.y-b.y,a.z-b.z);}V3 v3m(V3 a,f32 s){R v3(a.x*s,a.y*s,a.z*s);}f32 v3d(V3 a,V3 b){R a.x*b.x+a.y*b.y+a.z*b.z;}V3 v3c(V3 a,V3 b){R v3(a.y*b.z-a.z*b.y,a.z*b.x-a.x*b.z,a.x*b.y-a.y*b.x);}V3 v3n(V3 a){f32 l=sqrtf(v3d(a,a));R l>1e-6?v3m(a,1/l):v3(0,0,1);}
M4 m4i(){M4 m={0};m.m[0]=m.m[5]=m.m[10]=m.m[15]=1;R m;}M4 m4p(f32 f,f32 a,f32 n,f32 r){M4 m={0};f32 t=tanf(f*.5f),_r=r-n;m.m[0]=1/(a*t);m.m[5]=1/t;m.m[10]=-(r+n)/_r;m.m[11]=-1;m.m[14]=-2*r*n/_r;R m;}M4 m4l(V3 e,V3 c,V3 u){V3 f=v3n(v3s(c,e)),s=v3n(v3c(f,u)),U=v3c(s,f);M4 m={0};m.m[0]=s.x;m.m[4]=s.y;m.m[8]=s.z;m.m[1]=U.x;m.m[5]=U.y;m.m[9]=U.z;m.m[2]=-f.x;m.m[6]=-f.y;m.m[10]=-f.z;m.m[12]=-v3d(s,e);m.m[13]=-v3d(U,e);m.m[14]=v3d(f,e);m.m[15]=1;R m;}M4 m4m(M4 a,M4 b){M4 r={0};L(4,L(4,i32 j=_i;L(4,i32 k=_i;r.m[j*4+k]+=a.m[j*4+_i]*b.m[_i*4+k];);););R r;}
u32 fm(VkPhysicalDevice p,u32 t,VkMemoryPropertyFlags pr){VkPhysicalDeviceMemoryProperties mp;vkGetPhysicalDeviceMemoryProperties(p,&mp);L(mp.memoryTypeCount,if((t&(1<<_i))&&(mp.memoryTypes[_i].propertyFlags&pr)==pr)R _i;);R 0;}
void cb(VkDevice d,VkPhysicalDevice p,BU*b,u32 s,VkBufferUsageFlags u){VkBufferCreateInfo ci={VK_STRUCTURE_TYPE_BUFFER_CREATE_INFO,0,0,s,u,VK_SHARING_MODE_EXCLUSIVE,0,0};vkCreateBuffer(d,&ci,0,&b->b);VkMemoryRequirements mr;vkGetBufferMemoryRequirements(d,b->b,&mr);VkMemoryAllocateInfo ai={VK_STRUCTURE_TYPE_MEMORY_ALLOCATE_INFO,0,mr.size,fm(p,mr.memoryTypeBits,VK_MEMORY_PROPERTY_HOST_VISIBLE_BIT|VK_MEMORY_PROPERTY_HOST_COHERENT_BIT)};vkAllocateMemory(d,&ai,0,&b->m);vkBindBufferMemory(d,b->b,b->m,0);b->sz=s;}
void ci(VkDevice d,VkPhysicalDevice p,TX*t,u32 w,u32 h,VkFormat f){t->w=w;t->h=h;VkImageCreateInfo ii={VK_STRUCTURE_TYPE_IMAGE_CREATE_INFO,0,0,VK_IMAGE_TYPE_2D,f,{w,h,1},1,1,VK_SAMPLE_COUNT_1_BIT,VK_IMAGE_TILING_OPTIMAL,VK_IMAGE_USAGE_DEPTH_STENCIL_ATTACHMENT_BIT,VK_SHARING_MODE_EXCLUSIVE,0,0,VK_IMAGE_LAYOUT_UNDEFINED};vkCreateImage(d,&ii,0,&t->i);VkMemoryRequirements mr;vkGetImageMemoryRequirements(d,t->i,&mr);VkMemoryAllocateInfo ai={VK_STRUCTURE_TYPE_MEMORY_ALLOCATE_INFO,0,mr.size,fm(p,mr.memoryTypeBits,VK_MEMORY_PROPERTY_DEVICE_LOCAL_BIT)};vkAllocateMemory(d,&ai,0,&t->m);vkBindImageMemory(d,t->i,t->m,0);VkImageViewCreateInfo vi={VK_STRUCTURE_TYPE_IMAGE_VIEW_CREATE_INFO,0,0,t->i,VK_IMAGE_VIEW_TYPE_2D,f,{},{VK_IMAGE_ASPECT_DEPTH_BIT,0,1,0,1}};vkCreateImageView(d,&vi,0,&t->v);}
u8*lf(const char*p,u32*sz){FILE*f=fopen(p,"rb");if(!f)R 0;fseek(f,0,2);*sz=ftell(f);fseek(f,0,0);u8*b=M(*sz);fread(b,1,*sz,f);fclose(f);R b;}
VkShaderModule csm(VkDevice d,const char*p){u32 s;u8*c=lf(p,&s);if(!c)R 0;VkShaderModuleCreateInfo ci={VK_STRUCTURE_TYPE_SHADER_MODULE_CREATE_INFO,0,0,s,(u32*)c};VkShaderModule m;vkCreateShaderModule(d,&ci,0,&m);F(c);R m;}
TX ltx(VkDevice d,VkPhysicalDevice p,VkQueue q,VkCommandPool cp,const char*pt){TX t={0};u32 sz;u8*fb=lf(pt,&sz);if(!fb||sz<18)R t;u32 w=fb[12]|(fb[13]<<8),h=fb[14]|(fb[15]<<8),b=fb[16];if(b!=24&&b!=32){F(fb);R t;}u32 ps=w*h*(b/8),bp=b/8;u8*pd=M(w*h*4);for(u32 y=0;y<h;y++)for(u32 x=0;x<w;x++){u32 si=(y*w+x)*bp+18,di=(y*w+x)*4;pd[di]=fb[si+2];pd[di+1]=fb[si+1];pd[di+2]=fb[si];pd[di+3]=bp==4?fb[si+3]:255;}F(fb);VkBuffer sb;VkDeviceMemory sm;VkBufferCreateInfo bi={VK_STRUCTURE_TYPE_BUFFER_CREATE_INFO,0,0,w*h*4,VK_BUFFER_USAGE_TRANSFER_SRC_BIT};vkCreateBuffer(d,&bi,0,&sb);VkMemoryRequirements mr;vkGetBufferMemoryRequirements(d,sb,&mr);VkMemoryAllocateInfo ai={VK_STRUCTURE_TYPE_MEMORY_ALLOCATE_INFO,0,mr.size,fm(p,mr.memoryTypeBits,VK_MEMORY_PROPERTY_HOST_VISIBLE_BIT|VK_MEMORY_PROPERTY_HOST_COHERENT_BIT)};vkAllocateMemory(d,&ai,0,&sm);vkBindBufferMemory(d,sb,sm,0);void*mp;vkMapMemory(d,sm,0,w*h*4,0,&mp);memcpy(mp,pd,w*h*4);vkUnmapMemory(d,sm);F(pd);VkImageCreateInfo ii={VK_STRUCTURE_TYPE_IMAGE_CREATE_INFO,0,0,VK_IMAGE_TYPE_2D,VK_FORMAT_R8G8B8A8_UNORM,{w,h,1},1,1,VK_SAMPLE_COUNT_1_BIT,VK_IMAGE_TILING_OPTIMAL,VK_IMAGE_USAGE_TRANSFER_DST_BIT|VK_IMAGE_USAGE_SAMPLED_BIT};vkCreateImage(d,&ii,0,&t.i);vkGetImageMemoryRequirements(d,t.i,&mr);ai.allocationSize=mr.size;ai.memoryTypeIndex=fm(p,mr.memoryTypeBits,VK_MEMORY_PROPERTY_DEVICE_LOCAL_BIT);vkAllocateMemory(d,&ai,0,&t.m);vkBindImageMemory(d,t.i,t.m,0);VkCommandBufferAllocateInfo cai={VK_STRUCTURE_TYPE_COMMAND_BUFFER_ALLOCATE_INFO,0,cp,VK_COMMAND_BUFFER_LEVEL_PRIMARY,1};VkCommandBuffer cb;vkAllocateCommandBuffers(d,&cai,&cb);VkCommandBufferBeginInfo bbi={VK_STRUCTURE_TYPE_COMMAND_BUFFER_BEGIN_INFO,0,VK_COMMAND_BUFFER_USAGE_ONE_TIME_SUBMIT_BIT};vkBeginCommandBuffer(cb,&bbi);VkImageMemoryBarrier br={VK_STRUCTURE_TYPE_IMAGE_MEMORY_BARRIER,0,0,VK_ACCESS_TRANSFER_WRITE_BIT,VK_IMAGE_LAYOUT_UNDEFINED,VK_IMAGE_LAYOUT_TRANSFER_DST_OPTIMAL,~0U,~0U,t.i,{VK_IMAGE_ASPECT_COLOR_BIT,0,1,0,1}};vkCmdPipelineBarrier(cb,VK_PIPELINE_STAGE_TOP_OF_PIPE_BIT,VK_PIPELINE_STAGE_TRANSFER_BIT,0,0,0,0,0,1,&br);VkBufferImageCopy rg={0,0,0,{VK_IMAGE_ASPECT_COLOR_BIT,0,0,1},{0,0,0},{w,h,1}};vkCmdCopyBufferToImage(cb,sb,t.i,VK_IMAGE_LAYOUT_TRANSFER_DST_OPTIMAL,1,&rg);br.srcAccessMask=VK_ACCESS_TRANSFER_WRITE_BIT;br.dstAccessMask=VK_ACCESS_SHADER_READ_BIT;br.oldLayout=VK_IMAGE_LAYOUT_TRANSFER_DST_OPTIMAL;br.newLayout=VK_IMAGE_LAYOUT_SHADER_READ_ONLY_OPTIMAL;vkCmdPipelineBarrier(cb,VK_PIPELINE_STAGE_TRANSFER_BIT,VK_PIPELINE_STAGE_FRAGMENT_SHADER_BIT,0,0,0,0,0,1,&br);vkEndCommandBuffer(cb);VkSubmitInfo si={VK_STRUCTURE_TYPE_SUBMIT_INFO,0,0,0,0,1,&cb,0,0};vkQueueSubmit(q,1,&si,0);vkQueueWaitIdle(q);vkFreeCommandBuffers(d,cp,1,&cb);vkDestroyBuffer(d,sb,0);vkFreeMemory(d,sm,0);VkImageViewCreateInfo vi={VK_STRUCTURE_TYPE_IMAGE_VIEW_CREATE_INFO,0,0,t.i,VK_IMAGE_VIEW_TYPE_2D,VK_FORMAT_R8G8B8A8_UNORM,{},{VK_IMAGE_ASPECT_COLOR_BIT,0,1,0,1}};vkCreateImageView(d,&vi,0,&t.v);t.w=w;t.h=h;R t;}
BP*lb(const char*p){u32 sz;u8*d=lf(p,&sz);if(!d||sz<S(BH))R 0;BP*b=M(S(BP));b->d=d;b->sz=sz;memcpy(&b->h,d,S(BH));R b;}
void*bg(BP*b,i32 t,i32*n){BL*l=&b->h.e[t];if(l->o>=b->sz)R 0;if(n)*n=l->n;R b->d+l->o;}
MG lm(VkDevice d,VkPhysicalDevice p,VkQueue q,VkCommandPool cp,BP*b){MG g={0};i32 nv,ni,nf,nt;BV*bv=bg(b,10,&nv);u32*mi=bg(b,11,&ni);BF*fc=bg(b,13,&nf);BT*tx=bg(b,1,&nt);if(!bv||!mi||!fc||nv<3||ni<3||nf<1){printf("BSP data invalid: nv=%d ni=%d nf=%d\n",nv,ni,nf);R g;}printf("BSP: %d verts, %d indices, %d faces, %d textures\n",nv,ni,nf,nt);g.nv=nv;g.ni=ni;g.v=M(nv*S(BV));g.ix=M(ni*S(u32));memcpy(g.v,bv,nv*S(BV));memcpy(g.ix,mi,ni*S(u32));g.nt=nt>0?1:0;if(nt>0){g.tx=M(S(TX));char pth[256];snprintf(pth,256,"assets/textures/%s.tga",tx[0].n);g.tx[0]=ltx(d,p,q,cp,pth);if(!g.tx[0].v){char fp[256];snprintf(fp,256,"assets/levelshots/oa_dm1.tga");g.tx[0]=ltx(d,p,q,cp,fp);}}R g;}
typedef struct{SDL_Window*w;VkInstance ins;VkSurfaceKHR srf;VkPhysicalDevice pd;VkDevice dv;VkQueue gq;VkSwapchainKHR sc;VkImage*si;VkImageView*sv;u32 sic;VkRenderPass rp;VkPipelineLayout pl;VkPipeline pp;VkCommandPool cp;VkCommandBuffer*cb;VkSemaphore ia,rf;VkFence*ff;VkDescriptorSetLayout dsl;VkDescriptorPool dp;VkDescriptorSet*ds;BU ub;TX db;u32 W,H;i32 gfi;}VR;
void ri(VR*r){vkDeviceWaitIdle(r->dv);u32 ic;vkGetSwapchainImagesKHR(r->dv,r->sc,&ic,0);r->si=M(ic*S(VkImage));r->sv=M(ic*S(VkImageView));vkGetSwapchainImagesKHR(r->dv,r->sc,&ic,r->si);r->sic=ic;for(u32 j=0;j<ic;j++){VkImageViewCreateInfo vi={VK_STRUCTURE_TYPE_IMAGE_VIEW_CREATE_INFO,0,0,r->si[j],VK_IMAGE_VIEW_TYPE_2D,VK_FORMAT_B8G8R8A8_UNORM,{},{VK_IMAGE_ASPECT_COLOR_BIT,0,1,0,1}};vkCreateImageView(r->dv,&vi,0,&r->sv[j]);}ci(r->dv,r->pd,&r->db,r->W,r->H,VK_FORMAT_D32_SFLOAT);VkAttachmentDescription ad[2]={{0,VK_FORMAT_B8G8R8A8_UNORM,VK_SAMPLE_COUNT_1_BIT,VK_ATTACHMENT_LOAD_OP_CLEAR,VK_ATTACHMENT_STORE_OP_STORE,VK_ATTACHMENT_LOAD_OP_DONT_CARE,VK_ATTACHMENT_STORE_OP_DONT_CARE,VK_IMAGE_LAYOUT_UNDEFINED,VK_IMAGE_LAYOUT_PRESENT_SRC_KHR},{0,VK_FORMAT_D32_SFLOAT,VK_SAMPLE_COUNT_1_BIT,VK_ATTACHMENT_LOAD_OP_CLEAR,VK_ATTACHMENT_STORE_OP_DONT_CARE,VK_ATTACHMENT_LOAD_OP_DONT_CARE,VK_ATTACHMENT_STORE_OP_DONT_CARE,VK_IMAGE_LAYOUT_UNDEFINED,VK_IMAGE_LAYOUT_DEPTH_STENCIL_ATTACHMENT_OPTIMAL}};VkAttachmentReference cr={0,VK_IMAGE_LAYOUT_COLOR_ATTACHMENT_OPTIMAL},dr={1,VK_IMAGE_LAYOUT_DEPTH_STENCIL_ATTACHMENT_OPTIMAL};VkSubpassDescription sd={0,VK_PIPELINE_BIND_POINT_GRAPHICS,0,0,1,&cr,0,&dr,0,0};VkRenderPassCreateInfo rci={VK_STRUCTURE_TYPE_RENDER_PASS_CREATE_INFO,0,0,2,ad,1,&sd,0,0};vkCreateRenderPass(r->dv,&rci,0,&r->rp);VkDescriptorSetLayoutBinding bd[2]={{0,VK_DESCRIPTOR_TYPE_UNIFORM_BUFFER,1,VK_SHADER_STAGE_VERTEX_BIT,0},{1,VK_DESCRIPTOR_TYPE_COMBINED_IMAGE_SAMPLER,1,VK_SHADER_STAGE_FRAGMENT_BIT,0}};VkDescriptorSetLayoutCreateInfo dci={VK_STRUCTURE_TYPE_DESCRIPTOR_SET_LAYOUT_CREATE_INFO,0,0,2,bd};vkCreateDescriptorSetLayout(r->dv,&dci,0,&r->dsl);VkPipelineLayoutCreateInfo pci={VK_STRUCTURE_TYPE_PIPELINE_LAYOUT_CREATE_INFO,0,0,1,&r->dsl,0,0};vkCreatePipelineLayout(r->dv,&pci,0,&r->pl);VkShaderModule vs=csm(r->dv,"q3.vert.spv"),fs=csm(r->dv,"q3.frag.spv");VkPipelineShaderStageCreateInfo ss[2]={{VK_STRUCTURE_TYPE_PIPELINE_SHADER_STAGE_CREATE_INFO,0,0,VK_SHADER_STAGE_VERTEX_BIT,vs,"main",0},{VK_STRUCTURE_TYPE_PIPELINE_SHADER_STAGE_CREATE_INFO,0,0,VK_SHADER_STAGE_FRAGMENT_BIT,fs,"main",0}};VkVertexInputBindingDescription vbd={0,S(BV),VK_VERTEX_INPUT_RATE_VERTEX};VkVertexInputAttributeDescription vad[4]={{0,0,VK_FORMAT_R32G32B32_SFLOAT,0},{1,0,VK_FORMAT_R32G32B32_SFLOAT,12},{2,0,VK_FORMAT_R32G32_SFLOAT,24},{3,0,VK_FORMAT_R32G32_SFLOAT,32}};VkPipelineVertexInputStateCreateInfo vi={VK_STRUCTURE_TYPE_PIPELINE_VERTEX_INPUT_STATE_CREATE_INFO,0,0,1,&vbd,4,vad};VkPipelineInputAssemblyStateCreateInfo ia={VK_STRUCTURE_TYPE_PIPELINE_INPUT_ASSEMBLY_STATE_CREATE_INFO,0,0,VK_PRIMITIVE_TOPOLOGY_TRIANGLE_LIST,0};VkViewport vp={0,(f32)r->H,(f32)r->W,-(f32)r->H,0,1};VkRect2D sc={{0,0},{r->W,r->H}};VkPipelineViewportStateCreateInfo vps={VK_STRUCTURE_TYPE_PIPELINE_VIEWPORT_STATE_CREATE_INFO,0,0,1,&vp,1,&sc};VkPipelineRasterizationStateCreateInfo rs={VK_STRUCTURE_TYPE_PIPELINE_RASTERIZATION_STATE_CREATE_INFO,0,0,0,0,VK_POLYGON_MODE_FILL,VK_CULL_MODE_BACK_BIT,VK_FRONT_FACE_COUNTER_CLOCKWISE,0,0,0,0,1};VkPipelineMultisampleStateCreateInfo ms={VK_STRUCTURE_TYPE_PIPELINE_MULTISAMPLE_STATE_CREATE_INFO,0,0,VK_SAMPLE_COUNT_1_BIT,0,1,0,0,0};VkPipelineDepthStencilStateCreateInfo ds={VK_STRUCTURE_TYPE_PIPELINE_DEPTH_STENCIL_STATE_CREATE_INFO,0,0,1,1,VK_COMPARE_OP_LESS,0,0,{},{},0,1};VkPipelineColorBlendAttachmentState ca={0,VK_BLEND_FACTOR_ONE,VK_BLEND_FACTOR_ZERO,VK_BLEND_OP_ADD,VK_BLEND_FACTOR_ONE,VK_BLEND_FACTOR_ZERO,VK_BLEND_OP_ADD,15};VkPipelineColorBlendStateCreateInfo cbs={VK_STRUCTURE_TYPE_PIPELINE_COLOR_BLEND_STATE_CREATE_INFO,0,0,0,VK_LOGIC_OP_COPY,1,&ca,{0,0,0,0}};VkGraphicsPipelineCreateInfo gci={VK_STRUCTURE_TYPE_GRAPHICS_PIPELINE_CREATE_INFO,0,0,2,ss,&vi,&ia,0,&vps,&rs,&ms,&ds,&cbs,0,r->pl,r->rp,0,0,-1};vkCreateGraphicsPipelines(r->dv,0,1,&gci,0,&r->pp);vkDestroyShaderModule(r->dv,vs,0);vkDestroyShaderModule(r->dv,fs,0);VkCommandPoolCreateInfo cpci={VK_STRUCTURE_TYPE_COMMAND_POOL_CREATE_INFO,0,VK_COMMAND_POOL_CREATE_RESET_COMMAND_BUFFER_BIT,r->gfi};vkCreateCommandPool(r->dv,&cpci,0,&r->cp);r->cb=M(ic*S(VkCommandBuffer));VkCommandBufferAllocateInfo cai={VK_STRUCTURE_TYPE_COMMAND_BUFFER_ALLOCATE_INFO,0,r->cp,VK_COMMAND_BUFFER_LEVEL_PRIMARY,ic};vkAllocateCommandBuffers(r->dv,&cai,r->cb);VkSemaphoreCreateInfo sci={VK_STRUCTURE_TYPE_SEMAPHORE_CREATE_INFO,0,0};vkCreateSemaphore(r->dv,&sci,0,&r->ia);vkCreateSemaphore(r->dv,&sci,0,&r->rf);r->ff=M(ic*S(VkFence));for(u32 j=0;j<ic;j++){VkFenceCreateInfo fci={VK_STRUCTURE_TYPE_FENCE_CREATE_INFO,0,VK_FENCE_CREATE_SIGNALED_BIT};vkCreateFence(r->dv,&fci,0,&r->ff[j]);}VkDescriptorPoolSize ps[2]={{VK_DESCRIPTOR_TYPE_UNIFORM_BUFFER,ic},{VK_DESCRIPTOR_TYPE_COMBINED_IMAGE_SAMPLER,ic}};VkDescriptorPoolCreateInfo dpci={VK_STRUCTURE_TYPE_DESCRIPTOR_POOL_CREATE_INFO,0,0,ic,2,ps};vkCreateDescriptorPool(r->dv,&dpci,0,&r->dp);r->ds=M(ic*S(VkDescriptorSet));VkDescriptorSetLayout*ls=M(ic*S(VkDescriptorSetLayout));L(ic,ls[_i]=r->dsl;);VkDescriptorSetAllocateInfo dai={VK_STRUCTURE_TYPE_DESCRIPTOR_SET_ALLOCATE_INFO,0,r->dp,ic,ls};vkAllocateDescriptorSets(r->dv,&dai,r->ds);F(ls);cb(r->dv,r->pd,&r->ub,S(M4)*2,VK_BUFFER_USAGE_UNIFORM_BUFFER_BIT);}
int main(int ac,char**av){SDL_Init(SDL_INIT_VIDEO);SDL_Window*w=SDL_CreateWindow("Q3Vk",SDL_WINDOWPOS_CENTERED,SDL_WINDOWPOS_CENTERED,1920,1080,SDL_WINDOW_VULKAN|SDL_WINDOW_SHOWN);VR r={.W=1920,.H=1080,.w=w};u32 ec=0;SDL_Vulkan_GetInstanceExtensions(w,&ec,0);const char**en=M(ec*S(char*));SDL_Vulkan_GetInstanceExtensions(w,&ec,en);VkApplicationInfo ai={VK_STRUCTURE_TYPE_APPLICATION_INFO,0,"Q3Vk",1,0,0,VK_API_VERSION_1_0};VkInstanceCreateInfo ici={VK_STRUCTURE_TYPE_INSTANCE_CREATE_INFO,0,0,&ai,0,0,ec,en,0,0};vkCreateInstance(&ici,0,&r.ins);F(en);SDL_Vulkan_CreateSurface(w,r.ins,&r.srf);u32 dc=0;vkEnumeratePhysicalDevices(r.ins,&dc,0);VkPhysicalDevice*ds=M(dc*S(VkPhysicalDevice));vkEnumeratePhysicalDevices(r.ins,&dc,ds);r.pd=ds[0];F(ds);u32 qc=0;vkGetPhysicalDeviceQueueFamilyProperties(r.pd,&qc,0);VkQueueFamilyProperties*qp=M(qc*S(VkQueueFamilyProperties));vkGetPhysicalDeviceQueueFamilyProperties(r.pd,&qc,qp);r.gfi=-1;L(qc,if(qp[_i].queueFlags&VK_QUEUE_GRAPHICS_BIT){VkBool32 ps;vkGetPhysicalDeviceSurfaceSupportKHR(r.pd,_i,r.srf,&ps);if(ps){r.gfi=_i;break;}});F(qp);f32 qpr=1;VkDeviceQueueCreateInfo qci={VK_STRUCTURE_TYPE_DEVICE_QUEUE_CREATE_INFO,0,0,r.gfi,1,&qpr};const char*de[]={VK_KHR_SWAPCHAIN_EXTENSION_NAME};VkPhysicalDeviceFeatures df={0};VkDeviceCreateInfo dci={VK_STRUCTURE_TYPE_DEVICE_CREATE_INFO,0,0,1,&qci,0,0,1,de,&df};vkCreateDevice(r.pd,&dci,0,&r.dv);vkGetDeviceQueue(r.dv,r.gfi,0,&r.gq);VkSurfaceCapabilitiesKHR cap;vkGetPhysicalDeviceSurfaceCapabilitiesKHR(r.pd,r.srf,&cap);VkSwapchainCreateInfoKHR sci={VK_STRUCTURE_TYPE_SWAPCHAIN_CREATE_INFO_KHR,0,0,r.srf,cap.minImageCount,VK_FORMAT_B8G8R8A8_UNORM,VK_COLOR_SPACE_SRGB_NONLINEAR_KHR,{r.W,r.H},1,VK_IMAGE_USAGE_COLOR_ATTACHMENT_BIT,VK_SHARING_MODE_EXCLUSIVE,0,0,cap.currentTransform,VK_COMPOSITE_ALPHA_OPAQUE_BIT_KHR,VK_PRESENT_MODE_FIFO_KHR,1,0};vkCreateSwapchainKHR(r.dv,&sci,0,&r.sc);ri(&r);BP*bp=lb("assets/maps/oa_dm1.bsp");if(!bp){printf("Failed load BSP\n");R 1;}MG mg=lm(r.dv,r.pd,r.gq,r.cp,bp);if(!mg.nv){printf("Failed parse BSP\n");R 1;}BU vb,ib;cb(r.dv,r.pd,&vb,mg.nv*S(BV),VK_BUFFER_USAGE_VERTEX_BUFFER_BIT);cb(r.dv,r.pd,&ib,mg.ni*S(u32),VK_BUFFER_USAGE_INDEX_BUFFER_BIT);void*dp;vkMapMemory(r.dv,vb.m,0,mg.nv*S(BV),0,&dp);memcpy(dp,mg.v,mg.nv*S(BV));vkUnmapMemory(r.dv,vb.m);vkMapMemory(r.dv,ib.m,0,mg.ni*S(u32),0,&dp);memcpy(dp,mg.ix,mg.ni*S(u32));vkUnmapMemory(r.dv,ib.m);VkSamplerCreateInfo sci2={VK_STRUCTURE_TYPE_SAMPLER_CREATE_INFO,0,0,VK_FILTER_LINEAR,VK_FILTER_LINEAR,VK_SAMPLER_MIPMAP_MODE_LINEAR,VK_SAMPLER_ADDRESS_MODE_REPEAT,VK_SAMPLER_ADDRESS_MODE_REPEAT,VK_SAMPLER_ADDRESS_MODE_REPEAT,0,0,16,0,VK_COMPARE_OP_ALWAYS,0,0,VK_BORDER_COLOR_INT_OPAQUE_BLACK,0};VkSampler sa;vkCreateSampler(r.dv,&sci2,0,&sa);L(r.sic,VkDescriptorBufferInfo bi={r.ub.b,0,S(M4)*2};VkDescriptorImageInfo ii={sa,mg.tx[0].v,VK_IMAGE_LAYOUT_SHADER_READ_ONLY_OPTIMAL};VkWriteDescriptorSet wr[2]={{VK_STRUCTURE_TYPE_WRITE_DESCRIPTOR_SET,0,r.ds[_i],0,0,1,VK_DESCRIPTOR_TYPE_UNIFORM_BUFFER,0,&bi,0},{VK_STRUCTURE_TYPE_WRITE_DESCRIPTOR_SET,0,r.ds[_i],1,0,1,VK_DESCRIPTOR_TYPE_COMBINED_IMAGE_SAMPLER,&ii,0,0}};vkUpdateDescriptorSets(r.dv,2,wr,0,0););V3 ps=v3(0,0,100),vc=v3(0,0,1);f32 ya=0,pi=0;i32 run=1;u32 fr=0;while(run){SDL_Event e;while(SDL_PollEvent(&e)){if(e.type==SDL_QUIT)run=0;if(e.type==SDL_KEYDOWN&&e.key.keysym.sym==SDLK_ESCAPE)run=0;}const u8*ks=SDL_GetKeyboardState(0);f32 sp=5.0f;V3 fw=v3(cosf(ya)*cosf(pi),sinf(pi),sinf(ya)*cosf(pi));V3 rg=v3n(v3c(fw,vc));if(ks[SDL_SCANCODE_W])ps=v3a(ps,v3m(fw,sp));if(ks[SDL_SCANCODE_S])ps=v3s(ps,v3m(fw,sp));if(ks[SDL_SCANCODE_A])ps=v3s(ps,v3m(rg,sp));if(ks[SDL_SCANCODE_D])ps=v3a(ps,v3m(rg,sp));if(ks[SDL_SCANCODE_SPACE])ps.z+=sp;if(ks[SDL_SCANCODE_LSHIFT])ps.z-=sp;if(ks[SDL_SCANCODE_LEFT])ya-=0.05f;if(ks[SDL_SCANCODE_RIGHT])ya+=0.05f;if(ks[SDL_SCANCODE_UP])pi+=0.05f;if(ks[SDL_SCANCODE_DOWN])pi-=0.05f;M4 vm=m4l(ps,v3a(ps,fw),vc);M4 pm=m4p(1.22f,16.0f/9.0f,0.1f,10000.0f);M4 vp=m4m(pm,vm);vkMapMemory(r.dv,r.ub.m,0,S(M4)*2,0,&dp);memcpy(dp,&vp,S(M4));memcpy((u8*)dp+S(M4),&m4i(),S(M4));vkUnmapMemory(r.dv,r.ub.m);u32 ii;vkAcquireNextImageKHR(r.dv,r.sc,~0ULL,r.ia,0,&ii);vkWaitForFences(r.dv,1,&r.ff[ii],1,~0ULL);vkResetFences(r.dv,1,&r.ff[ii]);VkCommandBuffer C=r.cb[ii];vkResetCommandBuffer(C,0);VkCommandBufferBeginInfo bbi={VK_STRUCTURE_TYPE_COMMAND_BUFFER_BEGIN_INFO};vkBeginCommandBuffer(C,&bbi);VkFramebufferCreateInfo fci={VK_STRUCTURE_TYPE_FRAMEBUFFER_CREATE_INFO,0,0,r.rp,2,(VkImageView[]){r.sv[ii],r.db.v},r.W,r.H,1};VkFramebuffer fb;vkCreateFramebuffer(r.dv,&fci,0,&fb);VkClearValue cv[2]={{{.1f,.1f,.15f,1}},{{1,0}}};VkRenderPassBeginInfo rbi={VK_STRUCTURE_TYPE_RENDER_PASS_BEGIN_INFO,0,r.rp,fb,{{0,0},{r.W,r.H}},2,cv};vkCmdBeginRenderPass(C,&rbi,VK_SUBPASS_CONTENTS_INLINE);vkCmdBindPipeline(C,VK_PIPELINE_BIND_POINT_GRAPHICS,r.pp);VkDeviceSize of=0;vkCmdBindVertexBuffers(C,0,1,&vb.b,&of);vkCmdBindIndexBuffer(C,ib.b,0,VK_INDEX_TYPE_UINT32);vkCmdBindDescriptorSets(C,VK_PIPELINE_BIND_POINT_GRAPHICS,r.pl,0,1,&r.ds[ii],0,0);vkCmdDrawIndexed(C,mg.ni,1,0,0,0);vkCmdEndRenderPass(C);vkEndCommandBuffer(C);VkPipelineStageFlags wf=VK_PIPELINE_STAGE_COLOR_ATTACHMENT_OUTPUT_BIT;VkSubmitInfo si={VK_STRUCTURE_TYPE_SUBMIT_INFO,0,1,&r.ia,&wf,1,&C,1,&r.rf};vkQueueSubmit(r.gq,1,&si,r.ff[ii]);VkPresentInfoKHR pi2={VK_STRUCTURE_TYPE_PRESENT_INFO_KHR,0,1,&r.rf,1,&r.sc,&ii,0};vkQueuePresentKHR(r.gq,&pi2);vkDestroyFramebuffer(r.dv,fb,0);if(++fr%60==0)printf("F%d P%.0f,%.0f,%.0f Y%.2f\n",fr,ps.x,ps.y,ps.z,ya);}vkDeviceWaitIdle(r.dv);SDL_DestroyWindow(w);SDL_Quit();R 0;}
